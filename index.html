<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan Dragon Gate V24</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        body { background-color: #2c3e50; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; margin: 0; }
        .container { max-width: 500px; margin: 0 auto; background: #34495e; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); position: relative; }
        
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .nav-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ecf0f1; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: background 0.2s; margin-left: 5px; }
        .nav-btn:hover { background: rgba(255,255,255,0.2); }

        h1 { color: #f1c40f; margin: 5px 0 15px 0; font-size: 28px; letter-spacing: 1px; }
        
        .pool-box { background: linear-gradient(135deg, #f39c12, #f1c40f); color: #2c3e50; padding: 10px 25px; border-radius: 5px; display: inline-block; font-weight: bold; font-size: 1.2em; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .note-text { color: #bdc3c7; font-size: 0.85em; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 8px 15px; border-radius: 5px; display: inline-block; }
        .limit-info { color: #bdc3c7; font-size: 0.9em; margin-bottom: 5px; }

        .cards-area { display: flex; justify-content: center; gap: 15px; margin: 25px 0; height: 140px; }
        .card { width: 90px; height: 130px; background: #ecf0f1; color: #2c3e50; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 42px; font-weight: bold; border: 1px solid #bdc3c7; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card.hidden { background: #7f8c8d; color: #95a5a6; border-color: #636e72; }
        
        button { padding: 12px 25px; font-size: 16px; margin: 8px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; width: 45%; text-transform: uppercase; letter-spacing: 0.5px; }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button:active { transform: translateY(0); }
        button:disabled { background-color: #7f8c8d; cursor: not-allowed; transform: none; filter: none; opacity: 0.7; }
        
        .btn-connect { background-color: #3498db; color: white; width: 80%; }
        .btn-start { background-color: #2ecc71; color: white; width: 80%; }
        .btn-shoot { background-color: #e67e22; color: white; }
        .btn-fold { background-color: #95a5a6; color: white; }
        .input-bet { padding: 12px; border-radius: 8px; border: none; width: 100px; text-align: center; font-size: 18px; margin-right: 10px; background: #ecf0f1; color: #2c3e50; font-weight: bold; }
        
        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content { background: #34495e; padding: 30px; border-radius: 10px; text-align: center; border: 1px solid #7f8c8d; width: 90%; max-width: 420px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); transform: scale(0.95); transition: transform 0.3s; max-height: 85vh; overflow-y: auto; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        .modal-title { font-size: 32px; margin: 0 0 10px 0; font-weight: 800; text-transform: uppercase; }
        .modal-score { font-size: 18px; color: #bdc3c7; margin-bottom: 20px; }
        
        .modal-cards-wrapper { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 20px auto; }
        .modal-card { background: white; color: black; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #34495e; }
        .modal-card.side { width: 60px; height: 90px; font-size: 32px; opacity: 0.7; }
        .modal-card.main { width: 80px; height: 110px; font-size: 50px; z-index: 2; transition: all 0.3s; }
        
        .highlight-shot .modal-card.main { border-color: #f1c40f; box-shadow: 0 0 25px rgba(241, 196, 15, 0.8); transform: scale(1.15); }
        .fold-mode .modal-card.side { display: none; }

        .btn-close { background: #3498db; color: white; width: 100%; margin: 20px 0 0 0; }
        .warning-footer { margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .warning-text { color: #e74c3c; font-size: 0.85em; line-height: 1.5; font-weight: bold; }

        .rules-section { text-align: left; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .rules-section:last-child { border-bottom: none; }
        .rules-title { color: #f1c40f; font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .rules-desc { color: #bdc3c7; font-size: 0.95em; line-height: 1.5; margin: 0; }

        .counter-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .counter-item { background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; font-size: 0.9em; }
        .counter-val { font-weight: bold; color: #2ecc71; font-size: 1.1em; }
        .counter-label { color: #bdc3c7; font-size: 0.8em; }
        
        .loading { opacity: 0.6; pointer-events: none; }
        .ping-dot { width: 6px; height: 6px; background-color: #2ecc71; border-radius: 50%; display: inline-block; margin-left: 8px; opacity: 0; transition: opacity 0.2s; vertical-align: middle; }
        .ping-active { opacity: 1; }
        .balance-info { font-size: 0.9em; color: #2ecc71; margin-top: 5px; font-weight: bold; }
        .deck-info { color: #3498db; font-weight: bold; margin-bottom: 5px; font-size: 0.95em; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-bar">
        <div>
            <button class="nav-btn" onclick="openRules()"><span data-i18n="rules">è¦å‰‡</span></button>
            <button class="nav-btn" onclick="openCounter()">ğŸ“Š <span data-i18n="counter_btn">è¨˜ç‰Œå™¨</span></button>
        </div>
        <button class="nav-btn" onclick="toggleLanguage()">EN / ä¸­æ–‡</button>
    </div>

    <h1><span data-i18n="title">å°ç£å°„é¾é–€</span> <span id="pingDot" class="ping-dot"></span></h1>
    
    <div class="pool-box"><span data-i18n="pool">çæ± </span>: <span id="poolAmount">Loading...</span> CRO</div>
    
    <div class="deck-info">
        ğŸ´ Shoe #<span id="shoeCount">1</span> | 
        <span data-i18n="remain">å‰©é¤˜</span>: <span id="cardsRemaining">--</span>/156
    </div>

    <div class="limit-info"><span data-i18n="max_bet">æœ€é«˜æŠ•æ³¨</span>: <span id="maxBet">Loading...</span> CRO</div>
    
    <br>
    <button id="connectBtn" class="btn-connect" onclick="connectWallet()"><span data-i18n="connect">é€£æ¥éŒ¢åŒ…</span></button>
    <p id="walletAddress" style="font-size: 0.8em; color: #bdc3c7; margin-top:5px;"></p>
    <p id="walletBalance" class="balance-info"></p>

    <div class="cards-area">
        <div class="card" id="card1">?</div>
        <div class="card hidden" id="card3">?</div>
        <div class="card" id="card2">?</div>
    </div>

    <div id="status" style="min-height: 24px; color:#f39c12; font-weight:bold;"><span data-i18n="status_wait">è«‹å…ˆé€£æ¥éŒ¢åŒ…</span></div>

    <div id="controls" style="margin-top: 20px;">
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 15px;">
            <input type="number" id="betAmount" class="input-bet" placeholder="1" value="1" oninput="checkLimit()">
            <span>CRO</span>
        </div>
        <button id="startBtn" class="btn-start" onclick="startGame()" disabled><span data-i18n="start">é–‹å§‹éŠæˆ²</span></button>
    </div>

    <div id="gameControls" style="display:none; margin-top: 20px;">
        <button class="btn-shoot" onclick="shoot()"><span data-i18n="shoot">å°„é–€ (è´é›™å€)</span></button>
        <button class="btn-fold" onclick="fold()"><span data-i18n="fold">æ”¾æ£„ (é€€ 50%)</span></button>
    </div>

    <div class="warning-footer">
        <div class="warning-text">
            <span data-i18n="warning">åšå¼ˆæœ‰é¢¨éšªï¼Œè«‹é‡åŠ›è€Œç‚ºã€‚åˆ‡å‹¿éåº¦æŠ•æ³¨ï¼Œä»¥å…å‚¾å®¶è•©ç”¢ã€‚æœªæ»¿18æ­²è«‹å‹¿éŠç©ã€‚</span>
        </div>
    </div>
</div>

<div class="modal-overlay" id="resultModal">
    <div class="modal-content">
        <div class="modal-title" id="modalTitle">WIN</div>
        <div class="modal-score" id="modalPayout">+2.0 CRO</div>
        <div class="modal-cards-wrapper" id="resultCardsWrapper">
            <div class="modal-card side" id="modalCard1">?</div>
            <div class="modal-card main" id="modalCard3">?</div>
            <div class="modal-card side" id="modalCard2">?</div>
        </div>
        <button class="btn-close" onclick="closeModal()"><span data-i18n="play_again">å†ä¾†ä¸€å±€</span></button>
    </div>
</div>

<div class="modal-overlay" id="rulesModal">
    <div class="modal-content" style="text-align: left;">
        <h2 style="text-align: center; color: #f1c40f; margin-top: 0; margin-bottom: 20px;" data-i18n="rules_title">ğŸ“œ éŠæˆ²è¦å‰‡</h2>
        <div id="rulesContent"></div>
        <button class="btn-close" onclick="closeRules()"><span data-i18n="close">é—œé–‰</span></button>
    </div>
</div>

<div class="modal-overlay" id="counterModal">
    <div class="modal-content">
        <h2 style="color: #3498db; margin:0;" data-i18n="counter_title">ğŸ“Š è¨˜ç‰Œå™¨</h2>
        <p style="font-size:0.85em; color:#bdc3c7; margin-bottom:15px;" data-i18n="counter_desc">é¡¯ç¤ºç‰Œé´ä¸­å‰©é¤˜çš„ç‰Œæ•¸</p>
        <div id="counterGrid" class="counter-grid">Loading...</div>
        <button class="btn-close" onclick="closeCounter()"><span data-i18n="close">é—œé–‰</span></button>
    </div>
</div>

<script>
    // =========================================
    // ğŸ”¥ å·²æ›´æ–°ç‚ºä½ çš„æ–°åˆç´„åœ°å€
    const CONTRACT_ADDRESS = "0x6E7866bf3AB28420aA902143A9B6A36725cD965A"; 
    // =========================================

    const ABI = [
        "function startGame() external payable",
        "function shoot() external",
        "function fold() external",
        "function games(address) view returns (uint8 state, uint256 card1, uint256 card2, uint256 betAmount)",
        "function getContractBalance() external view returns (uint256)",
        "function getRemainingCards() external view returns (uint256[] memory)",
        "function getDeckStatus() external view returns (uint256 remaining, uint256 total, uint256 currentShoe)",
        "event GameStarted(address indexed player, uint256 card1, uint256 card2, uint256 betAmount)",
        "event GameEnded(address indexed player, uint256 card3, string result, uint256 payout)",
        "event DeckShuffled(uint256 timestamp, uint256 newShoeId)"
    ];

    const translations = {
        zh: {
            title: "å°ç£å°„é¾é–€", rules: "è¦å‰‡", pool: "çæ± ", max_bet: "æœ€é«˜æŠ•æ³¨", note: "è¨»è¨˜ï¼šæœ€å¤§ä¸‹æ³¨é¡ç‚ºçæ± çš„ 1/4", connect: "é€£æ¥éŒ¢åŒ…",
            status_wait: "è«‹å…ˆé€£æ¥éŒ¢åŒ…", status_ready: "æº–å‚™å°±ç·’", status_dealing: "ç™¼ç‰Œä¸­...", status_playing: "éŠæˆ²é€²è¡Œä¸­",
            status_shooting: "å°„é–€ä¸­...", status_folding: "æ”¾æ£„ä¸­...", start: "é–‹å§‹éŠæˆ²", shoot: "å°„é–€ (è´é›™å€)", fold: "æ”¾æ£„ (é€€ 50%)",
            warning: "åšå¼ˆæœ‰é¢¨éšªï¼Œè«‹é‡åŠ›è€Œç‚ºã€‚åˆ‡å‹¿éåº¦æŠ•æ³¨ï¼Œä»¥å…å‚¾å®¶è•©ç”¢ã€‚æœªæ»¿18æ­²è«‹å‹¿éŠç©ã€‚", play_again: "å†ä¾†ä¸€å±€",
            rules_title: "ğŸ“œ éŠæˆ²è¦å‰‡", close: "é—œé–‰", balance: "é¤˜é¡", remain: "å‰©é¤˜",
            counter_btn: "è¨˜ç‰Œå™¨", counter_title: "ğŸ“Š è¨˜ç‰Œå™¨", counter_desc: "ç›®å‰ç‰Œé´ä¸­å‰©é¤˜çš„ç‰Œæ•¸ (å…±3å‰¯)",
            rules_html: `<div class="rules-section"><div class="rules-title">éŠæˆ²æ©Ÿåˆ¶</div><p class="rules-desc">ä½¿ç”¨ 3 å‰¯ç‰Œ (156å¼µ)ï¼Œå‰©é¤˜ä¸€åŠæ™‚è‡ªå‹•æ´—ç‰Œã€‚</p></div>
                         <div class="rules-section"><div class="rules-title">å°„é–€</div><p class="rules-desc">ç¬¬ä¸‰å¼µç‰Œ ä»‹æ–¼å‰å…©å¼µä¹‹é–“ â” è´ 2 å€ã€‚</p></div>
                         <div class="rules-section"><div class="rules-title">æ’æŸ±</div><p class="rules-desc">ç¬¬ä¸‰å¼µç‰Œ ç­‰æ–¼å‰å…©å¼µä»»ä¸€å¼µ â” é€šæ®ºã€‚</p></div>`,
            win: "WINNER", lose: "YOU LOSE", hit_post: "HIT POST", bad_pair: "BAD PAIR", folded: "FOLDED",
            refund: "å·²é€€é‚„", lost_all: "å¤±å»æœ¬é‡‘", pair_lose: "å®ˆé–€å“¡é€šæ®º", limit_msg: "é‡‘é¡éé«˜", bet_too_high: "æŠ•æ³¨é¡éé«˜"
        },
        en: {
            title: "Soccer Shootout", rules: "Rules", pool: "Pool", max_bet: "Max Bet", note: "Note: Max bet is 1/4 of pool", connect: "Connect Wallet",
            status_wait: "Connect Wallet", status_ready: "Ready", status_dealing: "Dealing...", status_playing: "In Progress",
            status_shooting: "Shooting...", status_folding: "Folding...", start: "Kick Off", shoot: "Shoot (Win 2x)", fold: "Fold (Refund 50%)",
            warning: "Gambling involves risk. Bet responsibly. 18+ only.", play_again: "Play Again",
            rules_title: "ğŸ“œ Rules", close: "Close", balance: "Balance", remain: "Left",
            counter_btn: "Card Counter", counter_title: "ğŸ“Š Card Counter", counter_desc: "Remaining cards in the shoe (3 Decks)",
            rules_html: `<div class="rules-section"><div class="rules-title">Deck</div><p class="rules-desc">3 Decks (156 cards). Reshuffles at 50%.</p></div>
                         <div class="rules-section"><div class="rules-title">Goal</div><p class="rules-desc">3rd card BETWEEN first two â” Win 2x.</p></div>
                         <div class="rules-section"><div class="rules-title">Hit Post</div><p class="rules-desc">3rd card EQUALS either card â” Loss.</p></div>`,
            win: "GOAL!", lose: "MISSED", hit_post: "HIT POST", bad_pair: "BLOCKED", folded: "FOLDED",
            refund: "Refunded", lost_all: "Lost Bet", pair_lose: "Goalkeeper Blocked", limit_msg: "Too High", bet_too_high: "Bet Too High"
        }
    };

    let currentLang = 'zh';
    let provider, signer, contract;
    let currentMaxBet = 0;
    let userAddress = ""; 
    let isModalOpen = false; 
    let currentC1 = "?", currentC2 = "?";
    let caughtPairValue = null;

    function toggleLanguage() {
        currentLang = (currentLang === 'zh') ? 'en' : 'zh';
        updateUIText();
        updateUserBalance(userAddress); 
    }

    function updateUIText() {
        const lang = translations[currentLang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (lang[key]) el.innerHTML = lang[key]; 
        });
        document.getElementById('rulesContent').innerHTML = lang.rules_html;
        checkLimit(); 
    }

    function getText(key) { return translations[currentLang][key]; }
    function openRules() { document.getElementById('rulesModal').classList.add('active'); }
    function closeRules() { document.getElementById('rulesModal').classList.remove('active'); }
    
    async function openCounter() { 
        document.getElementById('counterModal').classList.add('active'); 
        await updateCounterData(); 
    }
    function closeCounter() { document.getElementById('counterModal').classList.remove('active'); }

    async function updateCounterData() {
        if(!contract) return;
        try {
            document.getElementById("counterGrid").innerHTML = "Loading...";
            const cards = await contract.getRemainingCards();
            const counts = {};
            for(let i=1; i<=13; i++) counts[i] = 0;
            for(const card of cards) {
                const val = Number(card);
                if(counts[val] !== undefined) counts[val]++;
            }
            let html = "";
            const labels = {1:"A", 11:"J", 12:"Q", 13:"K"};
            for(let i=1; i<=13; i++) {
                const label = labels[i] || i;
                const count = counts[i];
                const colorStyle = count <= 3 ? "color:#e74c3c" : "color:#2ecc71";
                html += `<div class="counter-item"><div class="counter-label">${label}</div><div class="counter-val" style="${colorStyle}">${count}</div></div>`;
            }
            document.getElementById("counterGrid").innerHTML = html;
        } catch(e) { console.error(e); }
    }

    async function connectWallet() {
        if (!window.ethereum) return alert("Please install MetaMask!");
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress(); 
            const network = await provider.getNetwork();
            if (network.chainId !== 338n && network.chainId !== 25n) return alert("Please switch to Cronos Mainnet (25) or Testnet (338)");

            const btn = document.getElementById("connectBtn");
            btn.innerHTML = "âœ… " + userAddress.substring(0,6) + "...";
            btn.disabled = true;
            document.getElementById("walletAddress").innerText = userAddress;
            document.getElementById("startBtn").disabled = false;

            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            listenToEvents();
            await updateGameInfo(); 
            await updateUserBalance(userAddress); 
            await checkGameState(userAddress);
            document.getElementById("status").innerText = getText('status_ready');
            startPolling();
        } catch (e) { alert("Connect Error: " + e.message); }
    }

    function startPolling() {
        const randomDelay = Math.floor(Math.random() * 2000 + 3000);
        setTimeout(async () => {
            if (contract && userAddress && !isModalOpen) {
                const dot = document.getElementById("pingDot");
                dot.classList.add("ping-active");
                setTimeout(() => dot.classList.remove("ping-active"), 500);
                await checkGameState(userAddress);
                await updateGameInfo(); 
                await updateUserBalance(userAddress); 
            }
            startPolling();
        }, randomDelay);
    }

    async function updateGameInfo() {
        if(!contract) return;
        try {
            const balance = await provider.getBalance(CONTRACT_ADDRESS);
            const balanceEth = parseFloat(ethers.formatEther(balance));
            document.getElementById("poolAmount").innerText = balanceEth.toFixed(2);
            currentMaxBet = balanceEth / 4;
            document.getElementById("maxBet").innerText = currentMaxBet.toFixed(2);

            const deckStatus = await contract.getDeckStatus();
            document.getElementById("cardsRemaining").innerText = deckStatus.remaining;
            document.getElementById("shoeCount").innerText = deckStatus.currentShoe;
            checkLimit(); 
        } catch (e) {}
    }

    async function updateUserBalance(address) {
        if (!provider || !address) return;
        try {
            const balance = await provider.getBalance(address);
            const formatted = parseFloat(ethers.formatEther(balance)).toFixed(4); 
            const label = getText('balance');
            document.getElementById("walletBalance").innerText = `${label}: ${formatted} CRO`;
        } catch (e) { console.error(e); }
    }

    function checkLimit() {
        const inputVal = parseFloat(document.getElementById("betAmount").value);
        const btn = document.getElementById("startBtn");
        const container = document.querySelector('.container');
        if (container.classList.contains("loading")) return;
        if (inputVal > currentMaxBet) {
            btn.disabled = true;
            btn.innerText = getText('limit_msg');
        } else if (contract) { 
            btn.disabled = false;
            btn.innerText = "â–¶ï¸ " + getText('start');
        }
    }

    async function checkGameState(address) {
        if (isModalOpen) return; 
        try {
            const game = await contract.games(address);
            if (game.state == 1) { 
                currentC1 = game.card1;
                currentC2 = game.card2;
                document.getElementById("card1").innerText = currentC1;
                document.getElementById("card2").innerText = currentC2;
                document.getElementById("card3").innerText = "?";
                document.getElementById("card3").classList.add("hidden");
                toggleControls("game");
                if (!document.querySelector('.container').classList.contains("loading")) {
                   document.getElementById("status").innerText = getText('status_playing');
                }
            } else {
                toggleControls("start");
            }
        } catch (e) {}
    }

    function toggleControls(mode) {
        if (mode === "game") {
            document.getElementById("controls").style.display = "none";
            document.getElementById("gameControls").style.display = "block";
        } else {
            document.getElementById("controls").style.display = "block";
            document.getElementById("gameControls").style.display = "none";
        }
    }

    function setLoading(isLoading) {
        const container = document.querySelector('.container');
        if (isLoading) container.classList.add("loading");
        else container.classList.remove("loading");
    }

    async function processReceipt(receipt) {
        let gameStartedFound = false;
        let gameEndedFound = false;
        let c3_res = 0, result_res = "", payout_res = 0;

        for (const log of receipt.logs) {
            try {
                const parsed = contract.interface.parseLog(log);
                if (parsed.name === "GameStarted") {
                    currentC1 = parsed.args.card1;
                    currentC2 = parsed.args.card2;
                    document.getElementById("card1").innerText = currentC1;
                    document.getElementById("card2").innerText = currentC2;
                    if (currentC1 == currentC2) caughtPairValue = currentC1; 
                    gameStartedFound = true;
                }
            } catch (e) { }
        }

        for (const log of receipt.logs) {
            try {
                const parsed = contract.interface.parseLog(log);
                if (parsed.name === "GameEnded") {
                    const { card3, result, payout } = parsed.args;
                    c3_res = card3;
                    result_res = result;
                    payout_res = payout;
                    gameEndedFound = true;
                }
            } catch (e) { }
        }

        if (gameEndedFound) {
            showResult(result_res, c3_res, payout_res);
            return true;
        }
        return false;
    }

    async function startGame() {
        try {
            currentC1 = "?"; currentC2 = "?"; caughtPairValue = null;
            const amount = document.getElementById("betAmount").value;
            if (amount <= 0) return alert("Invalid Amount");
            if (amount > currentMaxBet) return alert(getText('bet_too_high'));

            setLoading(true);
            document.getElementById("status").innerText = getText('status_dealing');
            const tx = await contract.startGame({ value: ethers.parseEther(amount) });
            const receipt = await tx.wait(); 
            
            const handled = await processReceipt(receipt);
            setLoading(false);
            
            if (!handled && !isModalOpen) await checkGameState(userAddress);
            updateUserBalance(userAddress); 
            updateGameInfo();

        } catch (error) {
            console.error(error);
            setLoading(false);
            if(error.reason && error.reason.includes("Bet too high")) alert(getText('bet_too_high'));
        }
    }

    async function shoot() {
        try {
            setLoading(true);
            document.getElementById("status").innerText = getText('status_shooting');
            const tx = await contract.shoot();
            const receipt = await tx.wait();
            await processReceipt(receipt);
            setLoading(false);
            updateUserBalance(userAddress);
            updateGameInfo();
        } catch (error) { setLoading(false); alert(error.message); }
    }

    async function fold() {
        try {
            setLoading(true);
            document.getElementById("status").innerText = getText('status_folding');
            const tx = await contract.fold();
            const receipt = await tx.wait();
            await processReceipt(receipt);
            setLoading(false);
            updateUserBalance(userAddress);
            updateGameInfo();
        } catch (error) { setLoading(false); alert(error.message); }
    }

    function showResult(result, c3, payout) {
        if(isModalOpen) return; 
        isModalOpen = true; 
        setLoading(false);

        const modal = document.getElementById("resultModal");
        const title = document.getElementById("modalTitle");
        const score = document.getElementById("modalPayout");
        const wrapper = document.getElementById("resultCardsWrapper");
        const card1 = document.getElementById("modalCard1");
        const card3 = document.getElementById("modalCard3");
        const card2 = document.getElementById("modalCard2");
        const payoutEth = ethers.formatEther(payout);
        
        wrapper.classList.remove("fold-mode");
        wrapper.classList.remove("highlight-shot");
        card1.innerText = currentC1;
        card2.innerText = currentC2;
        card3.innerText = c3;

        if (result === "WIN") {
            title.innerText = getText('win'); title.style.color = "#2ecc71";
            score.innerText = `+${payoutEth} CRO`; score.style.color = "#2ecc71";
            wrapper.classList.add("highlight-shot"); 
        } else if (result === "LOSE") {
            title.innerText = getText('lose'); title.style.color = "#e74c3c";
            score.innerText = getText('lost_all'); score.style.color = "#e74c3c";
            wrapper.classList.add("highlight-shot");
        } else if (result === "HIT POST") {
            title.innerText = getText('hit_post'); title.style.color = "#e67e22";
            score.innerText = getText('lost_all'); score.style.color = "#e67e22";
            wrapper.classList.add("highlight-shot");
        } else if (result === "BAD PAIR") {
            title.innerText = getText('bad_pair'); title.style.color = "#c0392b";
            score.innerText = getText('pair_lose'); score.style.color = "#c0392b";
            card3.innerText = caughtPairValue ? caughtPairValue : currentC1; 
        } else if (result === "FOLD") {
            title.innerText = getText('folded'); title.style.color = "#bdc3c7";
            score.innerText = `${getText('refund')} ${payoutEth} CRO`; score.style.color = "#2ecc71"; 
            card3.innerText = "-";
            wrapper.classList.add("fold-mode"); 
        }
        modal.classList.add("active");
    }

    function closeModal() {
        isModalOpen = false; 
        document.getElementById("resultModal").classList.remove("active");
        document.getElementById("card1").innerText = "?"; 
        document.getElementById("card2").innerText = "?";
        document.getElementById("card3").innerText = "?"; 
        document.getElementById("card3").classList.add("hidden");
        document.getElementById("status").innerText = getText('status_ready');
        toggleControls("start");
        updateGameInfo(); 
    }

    function listenToEvents() {
        contract.on("GameStarted", (player, c1, c2, bet) => {
            if(player !== signer.address) return;
            document.getElementById("card1").innerText = c1;
            document.getElementById("card2").innerText = c2;
            setLoading(false);
        });
        contract.on("GameEnded", (player, c3, result, payout) => {
            if(player !== signer.address) return;
            if(!isModalOpen) showResult(result, c3, payout);
        });
        contract.on("DeckShuffled", (ts, shoeId) => {
            updateGameInfo();
        });
    }

    updateUIText(); 
</script>

</body>
</html>
